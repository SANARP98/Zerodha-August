worker_processes  1;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  sendfile      on;
  server_tokens off;
  client_max_body_size 50m;

  map $http_upgrade $connection_upgrade { default upgrade; '' close; }

  server {
    listen 80;

    # keep redirects relative (prevents :8080 showing up)
    absolute_redirect off;
    port_in_redirect  off;

    # --- Static landing page ---
    root /usr/share/nginx/html;
    index index.html;
    location = /        { try_files /index.html =404; }
    location = /healthz { return 200 "ok\n"; }

    # ---------- FastAPI under /py/ ----------
    location = /py { return 301 /py/; }
    location ^~ /py/ {
      proxy_http_version 1.1;
      rewrite ^/py/(.*)$ /$1 break;

      proxy_set_header Host               $host;
      proxy_set_header X-Real-IP          $remote_addr;
      proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto  $scheme;
      proxy_set_header X-Forwarded-Host   $host;
      proxy_set_header X-Forwarded-Port   443;
      proxy_set_header X-Forwarded-Prefix /py;

      proxy_read_timeout 300;
      proxy_pass http://python:8000/;
      proxy_redirect off;
    }

    # ---------- n8n under /n8n/ ----------
    location = /n8n { return 301 /n8n/; }
    location ^~ /n8n/ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Host $host;
      proxy_set_header X-Forwarded-Port 443;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      proxy_read_timeout 300;
      proxy_pass http://n8n:5678/;
      proxy_redirect off;
    }

    # ---------- ngrok UI under /ngrok/ ----------
    location = /ngrok { return 301 /ngrok/; }
    location ^~ /ngrok/ {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header X-Forwarded-Port 443;

      proxy_read_timeout 300;
      proxy_pass http://ngrok:4040/;
      proxy_redirect off;
    }
  }
}
